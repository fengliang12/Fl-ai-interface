# GitHub Actions CI å·¥ä½œæµé…ç½®æ–‡ä»¶
name: CI Pipeline # å·¥ä½œæµåç§°

# è§¦å‘æ¡ä»¶ï¼šæ¨é€æˆ–æ‹‰å–è¯·æ±‚æ—¶æ‰§è¡Œ
on:
  push: # æ¨é€ä»£ç æ—¶è§¦å‘
    branches: [master, develop] # åœ¨masterå’Œdevelopåˆ†æ”¯è§¦å‘
  pull_request: # æ‹‰å–è¯·æ±‚æ—¶è§¦å‘
    branches: [master] # é’ˆå¯¹masteråˆ†æ”¯çš„PR
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

# è®¾ç½®å¹¶å‘æ§åˆ¶ï¼Œç¡®ä¿åŒä¸€åˆ†æ”¯åªæœ‰ä¸€ä¸ªå·¥ä½œæµè¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ä»»åŠ¡å®šä¹‰
jobs:
  # ESLint ä»£ç æ£€æŸ¥
  lint: # ä»£ç æ£€æŸ¥ä»»åŠ¡åç§°
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒï¼šUbuntuæœ€æ–°ç‰ˆ
    timeout-minutes: 10 # ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼š10åˆ†é’Ÿ

    steps: # æ‰§è¡Œæ­¥éª¤åˆ—è¡¨
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4 # å®‰è£…PNPMåŒ…ç®¡ç†å™¨
        with: # é…ç½®å‚æ•°
          version: 8 # ä½¿ç”¨PNPMç‰ˆæœ¬8

      - uses: actions/setup-node@v4 # è®¾ç½®Node.jsç¯å¢ƒ
        with: # é…ç½®å‚æ•°
          node-version: 20 # ä½¿ç”¨Node.jsç‰ˆæœ¬20
          cache: 'pnpm' # å¯ç”¨PNPMç¼“å­˜åŠ é€Ÿå®‰è£…

      - name: Install dependencies and run ESLint # å®‰è£…ä¾èµ–å¹¶è¿è¡ŒESLint
        run: | # å¤šè¡Œå‘½ä»¤è„šæœ¬
          pnpm install --no-frozen-lockfile # å®‰è£…ä¾èµ–ï¼ˆå…è®¸æ›´æ–°é”å®šæ–‡ä»¶ï¼‰
          pnpm run lint # è¿è¡ŒESLintä»£ç é£æ ¼æ£€æŸ¥

  # å•å…ƒæµ‹è¯•
  test: # å•å…ƒæµ‹è¯•ä»»åŠ¡åç§°
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒï¼šUbuntuæœ€æ–°ç‰ˆ
    timeout-minutes: 15 # ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼š15åˆ†é’Ÿ

    steps: # æ‰§è¡Œæ­¥éª¤åˆ—è¡¨
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4 # å®‰è£…PNPMåŒ…ç®¡ç†å™¨
        with: # é…ç½®å‚æ•°
          version: 8 # ä½¿ç”¨PNPMç‰ˆæœ¬8

      - uses: actions/setup-node@v4 # è®¾ç½®Node.jsç¯å¢ƒ
        with: # é…ç½®å‚æ•°
          node-version: 20 # ä½¿ç”¨Node.jsç‰ˆæœ¬20
          cache: 'pnpm' # å¯ç”¨PNPMç¼“å­˜åŠ é€Ÿå®‰è£…

      - name: Install dependencies and run tests # å®‰è£…ä¾èµ–å¹¶è¿è¡Œå•å…ƒæµ‹è¯•
        run: | # å¤šè¡Œå‘½ä»¤è„šæœ¬
          pnpm install --no-frozen-lockfile # å®‰è£…ä¾èµ–ï¼ˆå…è®¸æ›´æ–°é”å®šæ–‡ä»¶ï¼‰
          pnpm run test:unit:ci # è¿è¡ŒJestå•å…ƒæµ‹è¯•

  # E2Eæµ‹è¯•
  e2e: # E2Eæµ‹è¯•ä»»åŠ¡åç§°
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒï¼šUbuntuæœ€æ–°ç‰ˆ
    timeout-minutes: 20 # ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼š20åˆ†é’Ÿ

    steps: # æ‰§è¡Œæ­¥éª¤åˆ—è¡¨
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4 # å®‰è£…PNPMåŒ…ç®¡ç†å™¨
        with: # é…ç½®å‚æ•°
          version: 8 # ä½¿ç”¨PNPMç‰ˆæœ¬8

      - uses: actions/setup-node@v4 # è®¾ç½®Node.jsç¯å¢ƒ
        with: # é…ç½®å‚æ•°
          node-version: 20 # ä½¿ç”¨Node.jsç‰ˆæœ¬20
          cache: 'pnpm' # å¯ç”¨PNPMç¼“å­˜åŠ é€Ÿå®‰è£…

      - name: Install dependencies # å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile # å®‰è£…ä¾èµ–ï¼ˆå…è®¸æ›´æ–°é”å®šæ–‡ä»¶ï¼‰

      - name: Install Cypress binary # å®‰è£…CypressäºŒè¿›åˆ¶æ–‡ä»¶
        run: npx cypress install # ç¡®ä¿CypressäºŒè¿›åˆ¶æ–‡ä»¶å·²å®‰è£…

      - name: Start development server # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
        run: pnpm run dev & # åœ¨åå°å¯åŠ¨å¼€å‘æœåŠ¡å™¨
        env:
          CI: true

      - name: Wait for server to be ready # ç­‰å¾…æœåŠ¡å™¨å°±ç»ª
        run: npx wait-on http://localhost:3000 --timeout 60000 # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨

      - name: Run E2E tests # è¿è¡ŒE2Eæµ‹è¯•
        run: pnpm run test:e2e:ci # è¿è¡ŒCypress E2Eæµ‹è¯•

  # éƒ¨ç½²ä»»åŠ¡ - åªæœ‰åœ¨æ‰€æœ‰æµ‹è¯•é€šè¿‡åæ‰æ‰§è¡Œ
  deploy:
    runs-on: ubuntu-latest
    needs: [lint, test, e2e] # ä¾èµ–æ‰€æœ‰æµ‹è¯•ä»»åŠ¡å®Œæˆ
    if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/master' && github.event_name == 'push') || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'master') # æ‰‹åŠ¨è§¦å‘ã€masteråˆ†æ”¯pushæˆ–PRåˆå¹¶åˆ°masteræ—¶éƒ¨ç½²
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build for production
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=fl-ai-interface

      - name: Deployment success notification
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "âœ… All tests passed and application deployed to Cloudflare Pages."
