# 测试系统集成

本文档详细介绍项目的测试系统架构，包括单元测试和E2E测试的配置、实现和最佳实践。

## 安装测试依赖

### 单元测试依赖

```bash
# Jest 测试框架和相关工具
npm install --save-dev jest@30.1.3
npm install --save-dev jest-environment-jsdom@30.1.2
npm install --save-dev @jest/globals@30.0.5

# React 测试工具
npm install --save-dev @testing-library/react@16.3.0
npm install --save-dev @testing-library/jest-dom@6.8.0
npm install --save-dev @testing-library/user-event@14.6.1

# SWC 编译器（用于快速编译）
npm install --save-dev @swc/jest@0.2.39
npm install --save-dev @swc/core@1.13.3

# 测试报告工具
npm install --save-dev jest-stare@2.5.2

# 模拟工具
npm install --save-dev identity-obj-proxy@3.0.0
```

### E2E测试依赖

```bash
# Cypress E2E 测试框架
npm install --save-dev cypress@15.2.0

# Web3 测试工具
npm install --save-dev @synthetixio/synpress@4.1.1
npm install --save-dev @cypress/webpack-preprocessor@7.0.1

# 其他测试工具
npm install --save-dev puppeteer@24.15.0
npm install --save-dev selenium-webdriver@4.34.0
```

## 核心配置文件

### 单元测试配置

- **jest.config.js** - Jest 主配置文件
- **src/setupTests.js** - 测试环境设置
- **jest.setup.js** - 全局测试设置
- **jest-stare.json** - 测试报告配置

### E2E测试配置

- **cypress.config.js** - Cypress 主配置文件
- **tests/e2e/support/e2e.js** - E2E 测试支持文件
- **tests/e2e/support/commands.js** - 自定义命令定义
- **tests/e2e/fixtures/** - 测试数据文件

## 关键配置要点

### Jest 配置 (jest.config.js)

```javascript
module.exports = {
  // 测试环境设置为 jsdom (模拟浏览器环境)
  testEnvironment: 'jsdom',

  // 测试设置文件
  setupFilesAfterEnv: ['<rootDir>/src/setupTests.js'],
  setupFiles: ['<rootDir>/jest.setup.js'],

  // 模块路径映射
  moduleNameMapper: {
    // CSS 文件映射
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
    // 图片文件映射
    '\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$':
      'jest-transform-stub',
    // 路径别名映射
    '^@/(.*)$': '<rootDir>/src/$1',
  },

  // 测试文件匹配模式
  testMatch: [
    '<rootDir>/tests/unit/**/*.{test,spec}.{js,jsx,ts,tsx}',
    '<rootDir>/src/**/*.{test,spec}.{js,jsx,ts,tsx}',
  ],

  // 忽略的文件和目录
  testPathIgnorePatterns: [
    '<rootDir>/node_modules/',
    '<rootDir>/dist/',
    '<rootDir>/build/',
    '<rootDir>/tests/e2e/',
    '<rootDir>/cypress/',
  ],

  // 收集测试覆盖率
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/index.tsx',
    '!src/reportWebVitals.ts',
  ],

  // 覆盖率报告格式
  coverageReporters: ['text', 'lcov', 'html'],

  // 转换配置
  transform: {
    '^.+\\.(ts|tsx)$': '@swc/jest',
    '^.+\\.(js|jsx)$': 'babel-jest',
  },

  // Jest Stare 报告配置
  reporters: [
    'default',
    [
      'jest-stare',
      {
        resultDir: 'jest-stare',
        reportTitle: 'Web3 Frontend Tests',
        coverageLink: '../coverage/lcov-report/index.html',
      },
    ],
  ],
};
```

### Cypress 配置 (cypress.config.js)

```javascript
const { defineConfig } = require('cypress');

module.exports = defineConfig({
  e2e: {
    // 基础URL，指向本地开发服务器
    baseUrl: 'http://localhost:3000',

    // 测试文件存放目录
    specPattern: 'tests/e2e/**/*.cy.{js,jsx,ts,tsx}',

    // 支持文件目录
    supportFile: 'tests/e2e/support/e2e.js',

    // 视口设置
    viewportWidth: 1280,
    viewportHeight: 720,

    // 测试超时设置（Web3交互可能较慢）
    defaultCommandTimeout: 10000,
    requestTimeout: 10000,
    responseTimeout: 10000,
    pageLoadTimeout: 30000,

    // 在测试失败时录制视频和截图
    video: true,
    screenshotOnRunFailure: true,

    // Web3 测试环境变量
    env: {
      WALLET_PRIVATE_KEY: 'test_private_key_here',
      TEST_ACCOUNT_ADDRESS: '0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e8e8',
      NETWORK_URL: 'http://localhost:8545',
    },

    // 忽略Web3相关错误
    chromeWebSecurity: false,

    // 重试配置
    retries: {
      runMode: 2,
      openMode: 0,
    },
  },
});
```

## 单元测试系统

### 测试架构

```
tests/unit/
├── components/              # React 组件测试
│   ├── AddRedPacket.test.jsx   # 添加红包组件测试
│   ├── Dashboard.test.jsx      # 仪表板组件测试
│   ├── SendRedPacket.test.jsx  # 发送红包组件测试
│   └── TopInfo.test.jsx        # 顶部信息组件测试
├── hooks/                   # React Hooks 测试
│   ├── useENS.test.js         # ENS Hook 测试
│   └── useWallet.test.js      # 钱包 Hook 测试
└── utils/                   # 工具函数测试
    ├── getName.test.js        # 获取名称函数测试
    ├── index.test.js          # 地址格式化函数测试
    └── sum.test.js            # 数学计算函数测试
```

### 测试环境设置

#### setupTests.js - 测试环境初始化

```javascript
// 导入 Jest DOM 匹配器
require('@testing-library/jest-dom');

// 模拟 Web3 相关的全局对象
Object.defineProperty(window, 'ethereum', {
  writable: true,
  value: {
    request: jest.fn(),
    on: jest.fn(),
    removeListener: jest.fn(),
    isMetaMask: true,
  },
});

// 模拟 matchMedia (用于响应式测试)
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: jest.fn().mockImplementation((query) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: jest.fn(),
    removeListener: jest.fn(),
    addEventListener: jest.fn(),
    removeEventListener: jest.fn(),
    dispatchEvent: jest.fn(),
  })),
});

// 模拟 ResizeObserver 和 IntersectionObserver
global.ResizeObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn(),
}));

global.IntersectionObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn(),
}));

// 设置测试超时时间
jest.setTimeout(10000);
```

### 详细测试案例：地址格式化工具函数

以下是项目中 `addressFormat` 工具函数的完整测试案例：

```javascript
// tests/unit/utils/index.test.js
import { addressFormat } from '../../../src/utils/index';

describe('addressFormat', () => {
  // 测试有效以太坊地址的格式化
  test('formats valid Ethereum address correctly', () => {
    const address = '0x1234567890123456789012345678901234567890';
    const result = addressFormat(address);
    expect(result).toBe('0x1234...7890');
  });

  // 测试短地址处理
  test('handles short address correctly', () => {
    const address = '0x123456';
    const result = addressFormat(address);
    expect(result).toBe('0x1234...3456');
  });

  // 测试非0x开头地址处理
  test('returns "无效地址" for address not starting with 0x', () => {
    const address = '1234567890123456789012345678901234567890';
    const result = addressFormat(address);
    expect(result).toBe('无效地址');
  });

  // 测试空字符串处理
  test('returns "无效地址" for empty string', () => {
    const address = '';
    const result = addressFormat(address);
    expect(result).toBe('无效地址');
  });

  // 测试null和undefined处理
  test('returns "无效地址" for null input', () => {
    const result = addressFormat(null);
    expect(result).toBe('无效地址');
  });

  test('returns "无效地址" for undefined input', () => {
    const result = addressFormat(undefined);
    expect(result).toBe('无效地址');
  });

  // 测试边界值
  test('handles minimum valid address length', () => {
    const address = '0x1234';
    const result = addressFormat(address);
    expect(result).toBe('0x1234...1234');
  });

  // 测试极长地址
  test('handles very long address', () => {
    const address = '0x' + '1'.repeat(100);
    const result = addressFormat(address);
    expect(result).toBe('0x1111...1111');
  });

  // 测试混合大小写地址
  test('handles address with mixed case', () => {
    const address = '0xAbCdEf1234567890123456789012345678901234';
    const result = addressFormat(address);
    expect(result).toBe('0xAbCd...1234');
  });
});
```

### 测试最佳实践

1. **测试结构**：使用 AAA 模式（Arrange、Act、Assert）
2. **测试命名**：使用描述性的测试名称
3. **模拟依赖**：适当使用 mock 隔离测试单元
4. **异步测试**：使用 `async/await` 和 `waitFor` 处理异步操作
5. **覆盖率目标**：保持 70% 以上的测试覆盖率

## E2E测试系统

### 测试架构

```
tests/e2e/
├── support/
│   ├── commands.js          # 自定义命令定义
│   └── e2e.js              # 全局配置
├── fixtures/
│   └── redPacketData.json  # 测试数据
├── wallet-connection.cy.js  # 钱包连接测试
├── wallet-web3.cy.js       # Web3 功能测试
└── README.md               # E2E 测试文档
```

### Web3 钱包模拟系统

#### 自定义命令 (commands.js)

```javascript
// 设置 MetaMask 模拟环境
Cypress.Commands.add('setupMetaMask', (options = {}) => {
  const config = {
    address: options.address || '0x742d35Cc6634C0532925a3b8D4C9db96590c6C87',
    chainId: options.chainId || '0x1',
    networkId: options.networkId || '1',
    balance: options.balance || '0x1bc16d674ec80000', // 2 ETH
    ...options,
  };

  cy.on('window:before:load', (win) => {
    // 创建完整的MetaMask provider
    const metamaskProvider = {
      isMetaMask: true,
      selectedAddress: config.address,
      chainId: config.chainId,
      networkVersion: config.networkId,

      // 主要的request方法
      request: async ({ method, params = [] }) => {
        console.log(`🦊 MetaMask ${method}:`, params);

        switch (method) {
          case 'eth_requestAccounts':
          case 'eth_accounts':
            return [config.address];

          case 'eth_chainId':
            return config.chainId;

          case 'eth_getBalance':
            return config.balance;

          case 'eth_sendTransaction':
            return '0x' + Math.random().toString(16).substr(2, 64);

          case 'personal_sign':
            return '0x' + Math.random().toString(16).substr(2, 130);

          default:
            throw new Error(`Unsupported method: ${method}`);
        }
      },

      // 事件系统
      on: (event, callback) => {
        if (!win.ethereum._events) win.ethereum._events = {};
        if (!win.ethereum._events[event]) win.ethereum._events[event] = [];
        win.ethereum._events[event].push(callback);
      },

      emit: (event, ...args) => {
        if (win.ethereum._events && win.ethereum._events[event]) {
          win.ethereum._events[event].forEach((callback) => {
            try {
              callback(...args);
            } catch (err) {
              console.error('事件处理器错误:', err);
            }
          });
        }
      },
    };

    win.ethereum = metamaskProvider;
    console.log('✅ MetaMask initialized successfully');
  });
});

// 连接钱包命令
Cypress.Commands.add('connectWallet', () => {
  cy.window().then(async (win) => {
    if (win.ethereum) {
      const accounts = await win.ethereum.request({
        method: 'eth_requestAccounts',
      });
      console.log('🔗 Wallet connected:', accounts[0]);
      return accounts;
    }
  });
});

// 切换网络命令
Cypress.Commands.add('changeMetaMaskNetwork', (network) => {
  const networks = {
    mainnet: { chainId: '0x1', networkId: '1' },
    goerli: { chainId: '0x5', networkId: '5' },
    sepolia: { chainId: '0xaa36a7', networkId: '11155111' },
    localhost: { chainId: '0x539', networkId: '1337' },
  };

  const networkConfig = networks[network] || networks.mainnet;

  cy.window().then((win) => {
    if (win.ethereum) {
      win.ethereum.chainId = networkConfig.chainId;
      win.ethereum.networkVersion = networkConfig.networkId;
      win.ethereum.emit('chainChanged', networkConfig.chainId);
      console.log(`🌐 Network changed to: ${network}`);
    }
  });
});
```

### 详细测试案例：钱包连接流程

以下是项目中钱包连接功能的完整E2E测试案例：

```javascript
// tests/e2e/wallet-connection.cy.js
describe('钱包连接 E2E 测试', () => {
  beforeEach(() => {
    // 使用onBeforeLoad在页面加载前设置window.ethereum
    cy.visitWithWalletMocks('/');
    // 等待页面加载和useWallet初始化完成
    cy.wait(3000);
  });

  describe('整体的测试流程', () => {
    it('显示页面初始UI', () => {
      console.log('📋 步骤1: 验证页面基本元素');
      cy.contains('红包合约').should('be.visible');
    });

    it('手动连接--测试流程', () => {
      console.log('\n=== 开始测试手动连接 ===');

      // 重置连接状态为未连接
      cy.window().then((win) => {
        if (win.ethereum && win.ethereum._resetConnection) {
          win.ethereum._resetConnection();
          // 触发accountsChanged事件
          win.ethereum.emit('accountsChanged', []);
        }
      });

      // 步骤1: 验证页面基本元素加载
      console.log('📋 步骤1: 验证页面基本元素');
      cy.contains('红包合约').should('be.visible');

      // 步骤2: 验证初始状态 - 应该显示连接按钮
      console.log('🔍 步骤2: 检查初始连接状态');
      cy.get('[data-testid="connect-wallet-button"]')
        .should('be.visible')
        .should('contain', '连接钱包')
        .then(() => {
          console.log('✅ 初始状态正确: 显示连接钱包按钮');
        });

      // 步骤3: 点击连接钱包按钮，模拟connectWallet流程
      console.log('🔗 步骤3: 开始连接钱包流程');
      cy.get('[data-testid="connect-wallet-button"]')
        .click()
        .then(() => {
          console.log('🖱️ 已点击连接钱包按钮');
        });

      // 等待状态更新
      cy.wait(1000);

      // 步骤4: 验证UI状态变化
      console.log('🎯 步骤4: 验证连接后的UI状态');
      cy.get('body').then(($body) => {
        if ($body.find('[data-testid="wallet-info-button"]').length > 0) {
          console.log('✅ 发现钱包信息按钮，连接成功');
          cy.get('[data-testid="wallet-info-button"]')
            .should('be.visible')
            .then(() => {
              console.log('✅ 钱包信息按钮可见，测试通过');
            });
        } else {
          console.log('⚠️ 未发现钱包信息按钮，检查是否仍显示连接按钮');
          cy.get('[data-testid="connect-wallet-button"]')
            .should('be.visible')
            .then(() => {
              console.log('ℹ️ 仍显示连接按钮，可能需要调整模拟逻辑');
            });
        }
      });

      console.log('🏁 手动测试完成');
    });

    it('应该检测到Web3钱包信息', () => {
      cy.window().should('have.property', 'ethereum');
      cy.window().then((win) => {
        expect(win.ethereum).to.have.property('isMetaMask', true);
        expect(win.ethereum).to.have.property('selectedAddress');
        expect(win.ethereum.selectedAddress).to.match(/^0x[a-fA-F0-9]{40}$/);
      });
    });
  });
});
```

### E2E测试最佳实践

1. **页面加载前设置**：使用 `onBeforeLoad` 在页面加载前设置 `window.ethereum`
2. **等待机制**：给钱包初始化留出足够时间
3. **错误处理**：忽略Web3相关的预期错误
4. **数据清理**：每个测试前清理本地存储和会话存储
5. **视觉验证**：使用截图和视频记录测试过程

## package.json 脚本配置

```json
{
  "scripts": {
    "test:unit": "jest",
    "test:unit:ci": "jest --coverage --watchAll=false --ci --passWithNoTests",
    "test:e2e": "cypress open",
    "test:e2e:ci": "cypress run --headless --browser chrome",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:all": "npm run test:unit && npm run test:e2e:ci"
  }
}
```

## 测试报告和覆盖率

### Jest Stare 报告

- **报告目录**: `jest-stare/`
- **报告标题**: "Web3 Frontend Tests"
- **覆盖率链接**: 自动链接到覆盖率报告

### 覆盖率配置

```javascript
// 覆盖率收集范围
collectCoverageFrom: [
  'src/**/*.{js,jsx,ts,tsx}',
  '!src/**/*.d.ts',
  '!src/index.tsx',
  '!src/reportWebVitals.ts',
],

// 覆盖率报告格式
coverageReporters: ['text', 'lcov', 'html'],
```

## 最佳实践

### 单元测试最佳实践

1. **测试隔离**：每个测试应该独立运行
2. **模拟外部依赖**：使用 Jest mock 模拟 Web3 提供者
3. **异步测试**：正确处理 Promise 和异步操作
4. **边界值测试**：测试边界条件和异常情况
5. **可读性**：使用描述性的测试名称和清晰的断言

### E2E测试最佳实践

1. **环境一致性**：确保测试环境与生产环境一致
2. **数据管理**：使用固定的测试数据和清理机制
3. **等待策略**：使用智能等待而非固定延时
4. **错误恢复**：实现测试失败时的重试机制
5. **并行执行**：合理配置并行测试以提高效率

## 持续集成配置

### GitHub Actions 示例

```yaml
name: Tests
on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test:unit:ci

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run dev &
      - run: npm run test:e2e:ci
```

## 相关文档链接

- [Jest 官方文档](https://jestjs.io/docs/getting-started)
- [React Testing Library 文档](https://testing-library.com/docs/react-testing-library/intro/)
- [Cypress 官方文档](https://docs.cypress.io/)
- [Web3 测试最佳实践](https://ethereum.org/en/developers/docs/testing/)
- [项目 Webpack 构建系统](./05-Webpack构建系统.md)
- [项目 Web3 集成系统](./06-Web3集成系统.md)

---

**注意**: 本文档基于项目当前的测试配置和依赖版本。在升级依赖时，请相应更新配置文件和测试代码。
